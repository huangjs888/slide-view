<!--
 * @Author: Huangjs
 * @Date: 2021-10-15 15:24:21
 * @LastEditors: Huangjs
 * @LastEditTime: 2023-02-27 14:17:00
 * @Description: ******
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scaleable=no"
      name="viewport"
    />
    <title>transition-event</title>
  </head>

  <body style="position: relative; margin: 0; padding: 10px">
    <h2 style="text-align: center">测试transition事件</h2>
    <div
      style="position: relative; width: 100%; height: 60px; background: #eee"
    >
      <div
        id="test"
        style="
          position: absolute;
          left: 0;
          top: 0;
          width: 80px;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          color: #fff;
          background-color: #e75e58;
          padding: 0 20px;
        "
      >
        测试方块
      </div>
    </div>
    <div
      id="move"
      style="
        position: absolute;
        top: 160px;
        left: 10px;
        width: 80px;
        height: 80px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #eea151;
        color: #fff;
        margin-top: 80px;
        cursor: move;
        user-select: none;
      "
    >
      Move me
    </div>
    <div
      style="
        position: absolute;
        top: 60px;
        left: 60px;
        width: 1px;
        height: 100px;
        background: black;
      "
    ></div>
    <div
      style="
        position: absolute;
        top: 60px;
        left: 110px;
        width: 1px;
        height: 100px;
        background: black;
      "
    ></div>
    <div
      style="
        position: absolute;
        top: 60px;
        left: 160px;
        width: 1px;
        height: 100px;
        background: black;
      "
    ></div>
    <div
      style="
        position: absolute;
        top: 60px;
        left: 210px;
        width: 1px;
        height: 100px;
        background: black;
      "
    ></div>
    <button id="click" style="margin-top: 40px">Click me</button>
    <script>
      (function () {
        function onOnceTransitionEnd(ele, transitionEnd) {
          if (!ele) {
            return;
          }
          const transitionEndWrapper = (e) => {
            transitionEnd(e);
            ele.removeEventListener("transitionend", transitionEndWrapper);
          };
          ele.addEventListener("transitionend", transitionEndWrapper);
        }
        function onOnceTransitionCancel(ele, transitionCancel) {
          if (!ele) {
            return;
          }
          const transitionCancelWrapper = (e) => {
            transitionCancel(e);
            ele.removeEventListener(
              "transitioncancel",
              transitionCancelWrapper
            );
          };
          ele.addEventListener("transitioncancel", transitionCancelWrapper);
        }
        function onOnceTransitionStart(ele, transitionStart) {
          if (!ele) {
            return;
          }
          const transitionStartWrapper = (e) => {
            transitionStart(e);
            ele.removeEventListener("transitionstart", transitionStartWrapper);
          };
          ele.addEventListener("transitionstart", transitionStartWrapper);
        }
        function setStyle(ele, css) {
          if (!ele) {
            return;
          }
          return Object.keys(css).forEach((k) => {
            if (typeof css[k] === "undefined") {
              return;
            }
            const key =
              k.indexOf("-") !== -1
                ? k
                : k.replace(/([A-Z])/g, "-$1").toLowerCase();
            const val =
              typeof css[k] === "number" ? `${css[k]}px` : String(css[k]);
            ele.style.setProperty(key, val);
          });
        }
        const test = document.querySelector("#test");
        let t = new Date().getTime();
        test.addEventListener("transitionstart", (e) => {
          t = new Date().getTime();
          console.log("start", e);
        });
        test.addEventListener("transitionend", (e) => {
          console.log("end", e);
        });
        test.addEventListener("transitioncancel", (e) => {
          console.log("cancel", e);
        });

        const click = document.querySelector("#click");
        click.addEventListener("click", (e) => {
          let tt = Date.now();
          setStyle(test, {
            transform: `translateX(100px)`,
            transition: `transform 5s linear 0s`,
          });

          setTimeout(() => {
            console.log(444, (Date.now() - tt) / 1000);
            setStyle(test, {
              transform: `translateX(60px)`,
              transition: `transform 6s linear 0s`,
            });
          }, 3000);
          setTimeout(() => {
            console.log(222);
            setStyle(test, {
              transform: `translateX(300px)`,
              transition: `transform 5s linear 0s`,
            });
          }, 1000);
          setTimeout(() => {
            setStyle(test, {
              transform: `translateX(400px)`,
              transition: `transform 5s linear 0s`,
            });
            console.log(333, (Date.now() - tt) / 1000);
            tt = Date.now();
          }, 1000);
          setStyle(test, {
            transform: `translateX(200px)`,
            transition: `transform 5s linear 0s`,
          });
        });
        const move = document.querySelector("#move");
        let count = 0;
        move.addEventListener("mousedown", (e) => {
          e.stopImmediatePropagation();
          document.addEventListener("mousemove", mousemoved);
          document.addEventListener("mouseup", mouseupped);
          const x0 = event.clientX;
          const y0 = event.clientY;
          function mousemoved(e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            const dx = e.clientX - x0;
            const dy = e.clientY - y0;
            if (dx * dx + dy * dy < 3) {
              return;
            }
            setStyle(move, {
              top: 160 + dy,
              left: 10 + dx,
            });
            const v = count === 0 ? 200 : 200 + dx;
            console.log(dx, v);
            setStyle(test, {
              transform: `translateX(${v}px)`,
              transition: `transform 10000s ease ${-dx}s`,
            });
            count++;
          }

          function mouseupped(e) {
            e.stopImmediatePropagation();
            setStyle(move, {
              top: 160,
              left: 10,
            });
            document.removeEventListener("mousemove", mousemoved);
            document.removeEventListener("mouseup", mouseupped);
          }
        });
      })();
    </script>
  </body>
</html>
